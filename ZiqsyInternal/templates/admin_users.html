{% extends "base.html" %}

{% block title %}User Management - Ziqsy Internal{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="/dashboard" class="ziqsy-logo-link">
                <h3 class="ziqsy-logo">Z<span class="dna-i">i</span>qsy</h3>
            </a>
            <button class="toggle-btn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <div class="sidebar-content">

            
            <!-- Categories section -->
            <div class="categories-header mb-2">
                <h6 class="mb-0 text-uppercase text-white" style="font-size: 0.75rem; letter-spacing: 0.5px;">Categories</h6>
            </div>
            
            <div class="sidebar-actions mb-3">
                <button class="btn btn-sm btn-outline-light mb-2 sidebar-btn" data-bs-toggle="modal" data-bs-target="#createSectionModal">
                    <i class="fas fa-plus"></i>
                    <span>New Section</span>
                </button>
                <button class="btn btn-sm btn-outline-secondary sidebar-btn" data-bs-toggle="modal" data-bs-target="#createPageModal">
                    <i class="fas fa-folder"></i>
                    <span>Add Page</span>
                </button>
            </div>
            
            <div class="sections-list">
                {% for section in sections %}
                <div class="section-item">
                    <div class="section-header">
                        <h6 class="section-name">{{ section.name }}</h6>
                    </div>
                    <div class="pages-list">
                        {% for p in section.pages %}
                        <div class="page-item">
                            <a href="{{ url_for('view_page', page_id=p.id) }}" class="page-link sidebar-btn">
                                <i class="fas fa-{{ 'link' if p.page_type == 'link_operations' else 'list' if p.page_type == 'list' else 'chart-bar' if p.page_type == 'dataset' else 'folder' }}"></i>
                                <span>{{ p.name }}</span>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="sidebar-footer">
            <div class="theme-selector mb-3">
                <label class="theme-label mb-2 d-block">Theme:</label>
                <select class="theme-dropdown w-100" id="themeSelector" onchange="changeTheme()">
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                    <option value="modern">Modern</option>
                    <option value="oldschool">Old School</option>
                    <option value="steel">Steel</option>
                    <option value="gold">Gold</option>
                </select>
            </div>
            <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-light sidebar-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="content-header">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">
                    <h2 class="mb-0">User Management</h2>
                    <span class="badge bg-warning">Admin Only</span>
                </div>
                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#inviteUserModal">
                    <i class="fas fa-user-plus me-1"></i>Invite User
                </button>
            </div>
        </div>
        
        <div class="admin-content">
            <!-- Active Users -->
            <div class="admin-section">
                <h4>Active Users</h4>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Created</th>
                                <th>Last Login</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>{{ user.email }}</td>
                                <td>
                                    {% if user.is_admin %}
                                        <span class="badge bg-danger">Admin</span>
                                    {% else %}
                                        <span class="badge bg-info">User</span>
                                    {% endif %}
                                </td>
                                <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</td>
                                <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</td>
                                <td>
                                    {% if user.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="resetPassword({{ user.id }})">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        {% if not user.is_admin %}
                                        <button class="btn btn-outline-secondary" onclick="toggleUserStatus({{ user.id }})">
                                            {% if user.is_active %}
                                                <i class="fas fa-user-slash"></i>
                                            {% else %}
                                                <i class="fas fa-user-check"></i>
                                            {% endif %}
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pending Invitations -->
            {% if invitations %}
            <div class="admin-section">
                <h4>Pending Invitations</h4>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Sent</th>
                                <th>Expires</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invitation in invitations %}
                            <tr>
                                <td>{{ invitation.email }}</td>
                                <td>{{ invitation.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ invitation.expires_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if invitation.expires_at < moment.utcnow() %}
                                        <span class="badge bg-danger">Expired</span>
                                    {% else %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Invite User Modal -->
<div class="modal fade" id="inviteUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Invite New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="inviteUserForm">
                    <div class="mb-3">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="userEmail" required 
                               placeholder="user@ziqsy.com or user@technicologyltd.com">
                        <div class="form-text">Must be from @ziqsy.com or @technicologyltd.com domain</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="inviteUser()">Send Invitation</button>
            </div>
        </div>
    </div>
</div>

<!-- Credentials Modal -->
<div class="modal fade" id="credentialsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Account Created</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <h6>Account successfully created!</h6>
                    <p class="mb-0">The user can now log in with these credentials:</p>
                </div>
                <div class="credential-info">
                    <div class="mb-3">
                        <label class="form-label">Email:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="createdEmail" readonly>
                            <button class="btn btn-outline-secondary" onclick="copyToClipboard('createdEmail')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Temporary Password:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="createdPassword" readonly>
                            <button class="btn btn-outline-secondary" onclick="copyToClipboard('createdPassword')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <small>In production, these credentials would be automatically sent to the user via email.</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.admin-content {
    padding: 20px;
}

.admin-section {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.admin-section h4 {
    color: var(--text-color);
    margin-bottom: 16px;
    border-bottom: 2px solid var(--accent-color);
    padding-bottom: 8px;
}

.table {
    background: var(--card-bg);
    color: var(--text-color);
    border-radius: 8px;
    overflow: hidden;
}

.table th {
    background: var(--accent-color);
    color: white;
    border: none;
    font-weight: 600;
}

.table td {
    border-color: var(--border-color);
    vertical-align: middle;
}

.table tbody tr:hover {
    background: var(--hover-bg);
}

.credential-info {
    background: var(--code-bg);
    padding: 16px;
    border-radius: 8px;
    margin: 16px 0;
}

.modal-content {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
}

.modal-header {
    border-bottom: 1px solid var(--border-color);
}

.modal-footer {
    border-top: 1px solid var(--border-color);
}

.modal-title {
    color: var(--text-color);
}

.form-label {
    color: var(--text-color);
    font-weight: 600;
}

.form-control {
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    color: var(--text-color);
}

.form-control:focus {
    background: var(--input-bg);
    border-color: var(--accent-color);
    color: var(--text-color);
    box-shadow: 0 0 0 0.2rem rgba(20, 184, 166, 0.25);
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
}
</style>

<script>
function inviteUser() {
    const email = document.getElementById('userEmail').value.trim();
    
    if (!email) {
        alert('Please enter an email address');
        return;
    }
    
    fetch('/admin/invite-user', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close invite modal
            bootstrap.Modal.getInstance(document.getElementById('inviteUserModal')).hide();
            
            // Show credentials modal
            document.getElementById('createdEmail').value = data.email;
            document.getElementById('createdPassword').value = data.temporary_password;
            new bootstrap.Modal(document.getElementById('credentialsModal')).show();
            
            // Reset form
            document.getElementById('inviteUserForm').reset();
            
            // Refresh page after modal closes
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to invite user');
    });
}

function toggleUserStatus(userId) {
    if (!confirm('Are you sure you want to change this user\'s status?')) {
        return;
    }
    
    fetch(`/admin/toggle-user/${userId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update user status');
    });
}

function resetPassword(userId) {
    if (!confirm('Are you sure you want to reset this user\'s password?')) {
        return;
    }
    
    fetch(`/admin/reset-password/${userId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`New password: ${data.new_password}\n\n${data.note}`);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to reset password');
    });
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    element.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(element.value);
    
    // Show feedback
    const button = element.nextElementSibling;
    const originalIcon = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i>';
    setTimeout(() => {
        button.innerHTML = originalIcon;
    }, 1000);
}
</script>

{% include 'dashboard_modals.html' %}
{% endblock %}